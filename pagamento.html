<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Loucos Por Tapioca</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/imask"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>

    <header class="header-carrinho">
        <a href="carrinho.html" class="btn-voltar">
            <i class="fa-solid fa-chevron-left"></i>
        </a>
        <span class="titulo-voltar">Finalizar</span>
        <div class="info-sacola">
            <span class="texto-sacola">Total a Pagar</span>
            <span class="valor-sacola" id="valor-total-header">R$ 0,00</span>
        </div>
    </header>

    <main class="container-pagamento">
        
        <h3 class="titulo-secao"><i class="fa-regular fa-user"></i> Seus Dados</h3>
        
        <div class="box-input-animado">
            <label>Seu Nome:</label>
            <div class="input-icon">
                <i class="fa-solid fa-user"></i>
                <input type="text" id="cliente-nome" placeholder="Como podemos te chamar?">
            </div>
        </div>

        <div class="box-input-animado">
            <label>Seu Telefone / WhatsApp:</label>
            <div class="input-icon">
                <i class="fa-brands fa-whatsapp"></i>
                <input type="tel" id="cliente-tel" placeholder="(81) 90000-0000">
            </div>
        </div>

        <div class="divisor"></div>

        <h3 class="titulo-secao"><i class="fa-solid fa-map-location-dot"></i> Entrega ou Retirada?</h3>
        
        <div class="grupo-opcoes">
            <label class="card-opcao">
                <input type="radio" name="entrega" value="entrega" checked onchange="toggleEndereco()">
                <div class="conteudo-card">
                    <div class="icone-card"><i class="fa-solid fa-motorcycle"></i></div>
                    <div class="texto-card">
                        <strong>Entrega</strong>
                        <p>Receber em casa</p>
                    </div>
                    <div class="check-icon"><i class="fa-solid fa-circle-check"></i></div>
                </div>
            </label>

            <label class="card-opcao">
                <input type="radio" name="entrega" value="retirada" onchange="toggleEndereco()">
                <div class="conteudo-card">
                    <div class="icone-card"><i class="fa-solid fa-bag-shopping"></i></div>
                    <div class="texto-card">
                        <strong>Retirada</strong>
                        <p>Buscar no local</p>
                    </div>
                    <div class="check-icon"><i class="fa-solid fa-circle-check"></i></div>
                </div>
            </label>
        </div>

        <div id="box-endereco" style="display:block;">
            <div class="box-input-animado">
                <label>Rua / Avenida:</label>
                <div class="input-icon"><i class="fa-solid fa-road"></i><input type="text" id="end-rua" placeholder="Nome da rua"></div>
            </div>
            
            <div class="row-inputs">
                <div class="box-input-animado" style="flex: 1;">
                    <label>N√∫mero:</label>
                    <div class="input-icon"><i class="fa-solid fa-hashtag"></i><input type="text" id="end-num" placeholder="N¬∫"></div>
                </div>
                
                <div class="box-input-animado" style="flex: 2;">
                    <label>Bairro:</label>
                    <select id="end-bairro" onchange="calcularTotalComTaxa()" style="width:100%; padding:15px; border:1px solid #ddd; border-radius:10px; background:#fafafa; outline:none; height: 52px;">
                        <option value="0">Selecione o Bairro...</option>
                        <option value="0">Centro (Gr√°tis)</option>
                        <option value="5">Alto Santo Ant√¥nio (R$ 5,00)</option>
                        <option value="7">Bonan√ßa (R$ 7,00)</option>
                        <option value="10">Zona Rural (R$ 10,00)</option>
                    </select>
                </div>
            </div>

            <div class="box-input-animado">
                <label>Refer√™ncia (Opcional):</label>
                <div class="input-icon"><i class="fa-regular fa-flag"></i><input type="text" id="end-ref" placeholder="Pr√≥ximo a..."></div>
            </div>
        </div>

        <div class="divisor"></div>

        <h3 class="titulo-secao"><i class="fa-solid fa-ticket"></i> Cupom de Desconto</h3>
        <div class="box-input-animado">
            <div class="input-icon" style="display:flex; gap:10px;">
                <i class="fa-solid fa-tag" style="margin-top:12px"></i>
                <input type="text" id="cupom-codigo" placeholder="Digite seu c√≥digo aqui">
                <button onclick="validarCupom()" style="background:var(--brown-dark); color:white; border:none; padding:0 20px; border-radius:10px; cursor:pointer; font-weight:bold;">Aplicar</button>
            </div>
            <small id="msg-cupom" style="display:block; margin-top:5px; font-weight:bold; padding-left: 5px;"></small>
        </div>

        <div class="divisor"></div>

        <h3 class="titulo-secao"><i class="fa-solid fa-pen"></i> Observa√ß√µes</h3>
        <div class="box-input-animado">
            <label>Algum detalhe para a cozinha?</label>
            <div class="input-icon">
                <i class="fa-regular fa-comment-dots"></i>
                <input type="text" id="obs-pedido" placeholder="Ex: Sem cebola, ketchup extra...">
            </div>
        </div>

        <div class="divisor"></div>

        <h3 class="titulo-secao"><i class="fa-regular fa-credit-card"></i> Pagamento</h3>

        <div class="grupo-opcoes">
            <label class="card-opcao">
                <input type="radio" name="pagamento" value="pix">
                <div class="conteudo-card">
                    <div class="icone-card" style="color:#00bfa5;"><i class="fa-brands fa-pix"></i></div>
                    <div class="texto-card"><strong>Pix</strong><p>Pagamento instant√¢neo</p></div>
                    <div class="check-icon"><i class="fa-solid fa-circle-check"></i></div>
                </div>
            </label>
            <label class="card-opcao">
                <input type="radio" name="pagamento" value="cartao" checked>
                <div class="conteudo-card">
                    <div class="icone-card" style="color:#2979ff;"><i class="fa-regular fa-credit-card"></i></div>
                    <div class="texto-card"><strong>Cart√£o</strong><p>Leva a maquineta</p></div>
                    <div class="check-icon"><i class="fa-solid fa-circle-check"></i></div>
                </div>
            </label>
            <label class="card-opcao">
                <input type="radio" name="pagamento" value="dinheiro" onchange="toggleTroco()">
                <div class="conteudo-card">
                    <div class="icone-card" style="color:#4caf50;"><i class="fa-solid fa-money-bill-wave"></i></div>
                    <div class="texto-card"><strong>Dinheiro</strong><p>Pagamento em esp√©cie</p></div>
                    <div class="check-icon"><i class="fa-solid fa-circle-check"></i></div>
                </div>
            </label>
        </div>

        <div id="box-troco" class="box-input-animado" style="display:none;">
            <label>Troco para quanto?</label>
            <div class="input-icon">
                <i class="fa-solid fa-hand-holding-dollar"></i>
                <input type="tel" id="troco-cliente" placeholder="Ex: 50,00">
            </div>
        </div>

    </main>

    <footer class="footer-pagamento">
        <button class="btn-finalizar" onclick="finalizarPedido()">
            <span id="txt-btn">Enviar Pedido via WhatsApp</span> <i class="fa-brands fa-whatsapp"></i>
        </button>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        const SEU_NUMERO = "5581991243260"; 

        const firebaseConfig = {
            apiKey: "AlzaSyBp32ijeLw2LvNwKur5EaUj7B9WZ1G-AW0",
            authDomain: "loucosportapioca-57964.firebaseapp.com",
            projectId: "loucosportapioca-57964",
            storageBucket: "loucosportapioca-57964.firebasestorage.app",
            messagingSenderId: "371332659198",
            appId: "1:371332659198:web:330626357653acc00772af"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let totalCarrinho = 0;
        
        // --- CONFIGURA√á√ÉO DOS CUPONS ---
        // Aqui voc√™ cria seus cupons!
        // "CODIGO": { tipo: "porcentagem" ou "fixo", valor: 10 }
        const CUPONS_ATIVOS = {
            "PRIMEIRACOMPRA": { tipo: "porcentagem", valor: 10 }, // 10% de desconto
            "SEMANATAPIOCA":  { tipo: "fixo", valor: 5.00 },      // 5 reais de desconto
            "VIP":            { tipo: "porcentagem", valor: 20 }  // 20% de desconto
        };
        
        let cupomAplicado = null; // Guarda o cupom que o cliente usou

        document.addEventListener('DOMContentLoaded', () => {
            const elPhone = document.getElementById('cliente-tel');
            IMask(elPhone, { mask: '(00) 00000-0000' });
            
            const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
            totalCarrinho = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            
            calcularTotalComTaxa();
        });

        // --- FUN√á√ÉO PARA VALIDAR O CUPOM ---
        function validarCupom() {
            const codigo = document.getElementById('cupom-codigo').value.toUpperCase().trim();
            const msg = document.getElementById('msg-cupom');
            
            if (CUPONS_ATIVOS[codigo]) {
                cupomAplicado = { codigo: codigo, ...CUPONS_ATIVOS[codigo] };
                msg.style.color = "#00C851"; // Verde
                msg.innerText = `Cupom ${codigo} aplicado com sucesso! üéâ`;
            } else {
                cupomAplicado = null;
                msg.style.color = "#ff4444"; // Vermelho
                msg.innerText = "Cupom inv√°lido ou expirado.";
            }
            calcularTotalComTaxa();
        }

        // Calcula Total (Produtos + Entrega - Desconto)
        function calcularTotalComTaxa() {
            const bairroSelect = document.getElementById('end-bairro');
            let taxa = 0;
            
            const tipoEntrega = document.querySelector('input[name="entrega"]:checked').value;
            if(tipoEntrega === 'entrega') {
                taxa = parseFloat(bairroSelect.value) || 0;
            }

            let descontoValor = 0;
            // Se tiver cupom, calcula o desconto
            if (cupomAplicado) {
                if(cupomAplicado.tipo === 'porcentagem') {
                    descontoValor = totalCarrinho * (cupomAplicado.valor / 100);
                } else {
                    descontoValor = cupomAplicado.valor;
                }
            }

            // Garante que o total n√£o fique negativo
            let totalFinal = (totalCarrinho + taxa) - descontoValor;
            if (totalFinal < 0) totalFinal = 0;
            
            // Atualiza na tela
            document.getElementById('valor-total-header').innerText = 
                totalFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            return { totalFinal, taxa, descontoValor };
        }

        function toggleEndereco() {
            const tipo = document.querySelector('input[name="entrega"]:checked').value;
            document.getElementById('box-endereco').style.display = (tipo === 'entrega') ? 'block' : 'none';
            calcularTotalComTaxa();
        }

        function toggleTroco() {
            const tipo = document.querySelector('input[name="pagamento"]:checked').value;
            document.getElementById('box-troco').style.display = (tipo === 'dinheiro') ? 'block' : 'none';
        }
        
        document.querySelectorAll('input[name="pagamento"]').forEach(r => r.addEventListener('change', toggleTroco));

        function finalizarPedido() {
            const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
            if(carrinho.length === 0) return alert("Seu carrinho est√° vazio!");

            const nome = document.getElementById('cliente-nome').value.trim();
            const telefone = document.getElementById('cliente-tel').value.trim();
            const entrega = document.querySelector('input[name="entrega"]:checked').value;
            const pagamento = document.querySelector('input[name="pagamento"]:checked').value;
            const troco = document.getElementById('troco-cliente').value;
            const bairroSelect = document.getElementById('end-bairro');
            const obs = document.getElementById('obs-pedido').value.trim();

            if(!nome) return alert("Digite seu Nome!");
            if(telefone.length < 14) return alert("Digite um telefone v√°lido!");

            let enderecoCompleto = "Retirada no Local";
            let nomeBairro = "";
            
            if(entrega === 'entrega') {
                const rua = document.getElementById('end-rua').value.trim();
                const num = document.getElementById('end-num').value.trim();
                const ref = document.getElementById('end-ref').value.trim();
                nomeBairro = bairroSelect.options[bairroSelect.selectedIndex].text;

                if(!rua || !num || (bairroSelect.value == "0" && nomeBairro.includes("Selecione"))) {
                    return alert("Preencha o endere√ßo e selecione o Bairro!");
                }
                enderecoCompleto = `${rua}, N¬∫ ${num}, ${nomeBairro} ${ref ? '('+ref+')' : ''}`;
            }

            // Pega os valores finais
            const { totalFinal, taxa, descontoValor } = calcularTotalComTaxa();

            const btn = document.querySelector('.btn-finalizar');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
            btn.disabled = true;

            const pedido = {
                data: new Date(),
                status: 'pendente',
                cliente: { nome: nome, telefone: telefone },
                entrega: { tipo: entrega, endereco: enderecoCompleto, taxa: taxa },
                pagamento: { metodo: pagamento, troco: troco || "" },
                itens: carrinho,
                observacao: obs,
                cupom: cupomAplicado ? cupomAplicado.codigo : "", // Salva qual cupom foi usado
                desconto: descontoValor, // Salva quanto foi o desconto
                total: totalFinal
            };

            db.collection("pedidos").add(pedido).then((docRef) => {
                enviarZap(pedido, docRef.id);
            }).catch((error) => {
                console.error("Erro:", error);
                alert("Erro ao enviar. Tente novamente.");
                btn.disabled = false;
                btn.innerHTML = 'Enviar Pedido';
            });
        }

        function enviarZap(pedido, idPedido) {
            const totalFormatado = pedido.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const taxaFormatada = pedido.entrega.taxa ? ` (+ R$ ${pedido.entrega.taxa.toFixed(2)} entrega)` : '';
            const descontoFormatado = pedido.desconto ? ` (- R$ ${pedido.desconto.toFixed(2)} cupom)` : '';
            const idCurto = idPedido.slice(0, 5).toUpperCase();

            let msg = `*PEDIDO #${idCurto}* üåµ\n`;
            msg += `üë§ ${pedido.cliente.nome}\n`;
            msg += `üìû ${pedido.cliente.telefone}\n\n`;
            
            pedido.itens.forEach(i => {
                msg += `‚ñ™Ô∏è ${i.quantidade}x ${i.nome}\n`;
            });

            if(pedido.observacao) {
                msg += `\nüìù *Obs:* ${pedido.observacao}\n`;
            }

            // Se tiver cupom, mostra na mensagem
            if(pedido.cupom) {
                msg += `\nüéüÔ∏è *Cupom:* ${pedido.cupom}\n`;
            }

            msg += `\nüí∞ *Total: ${totalFormatado}* ${taxaFormatada}${descontoFormatado}\n`;
            
            if(pedido.entrega.tipo === 'entrega') {
                msg += `üè† *Entrega:*\n${pedido.entrega.endereco}\n`;
            } else {
                msg += `üëú *Retirada no Balc√£o*\n`;
            }

            msg += `üí≥ *Pagamento:* ${pedido.pagamento.metodo.toUpperCase()}\n`;
            if(pedido.pagamento.troco) msg += `üíµ *Troco para:* ${pedido.pagamento.troco}\n`;

            localStorage.removeItem('carrinho');
            const linkZap = `https://wa.me/${SEU_NUMERO}?text=${encodeURIComponent(msg)}`;
            window.open(linkZap, '_blank');
            window.location.href = "index.html";
        }
    </script>
</body>
</html>