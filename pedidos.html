<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozinha - Pedidos em Tempo Real</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS DE TELA (Monitor) --- */
        body { background: #eee; font-family: 'Poppins', sans-serif; padding: 20px; }
        .header-pedidos { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { color: #333; margin: 0; }
        
        .grid-pedidos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .card-pedido {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-left: 5px solid #ccc;
            animation: slideIn 0.3s ease;
            position: relative; /* Necess√°rio para a impress√£o */
        }
        
        .status-pendente { border-left-color: #ffbb33; }
        .status-pronto { border-left-color: #00C851; }

        .pedido-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .pedido-id { font-weight: 900; color: #555; font-size: 18px; }
        .pedido-hora { font-size: 12px; color: #999; }

        .info-cliente { font-size: 14px; margin-bottom: 10px; color: #333; }
        .info-cliente strong { display: block; font-size: 18px; }

        .lista-itens { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .item { display: flex; justify-content: space-between; font-size: 15px; margin-bottom: 8px; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
        .item-qtd { font-weight: 900; margin-right: 10px; font-size: 16px; }

        .pedido-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .total { font-size: 20px; font-weight: 900; color: #333; }

        /* Bot√µes de A√ß√£o */
        .acoes-btns { display: flex; gap: 10px; }
        .btn-acao { border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-pronto { background: #00C851; }
        .btn-arquivar { background: #333; }
        
        /* Bot√£o Imprimir (Visual na tela) */
        .btn-print { background: #e0e0e0; color: #333; padding: 10px; border-radius: 8px; cursor: pointer; border: none; font-size: 16px; transition: 0.2s; }
        .btn-print:hover { background: #d0d0d0; }

        @keyframes slideIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

        /* =========================================
           ESTILOS DE IMPRESS√ÉO (CUPOM T√âRMICO)
           ========================================= */
        @media print {
            /* 1. Esconde TUDO na p√°gina por padr√£o */
            body * {
                visibility: hidden;
                height: 0; /* Evita ocupar espa√ßo */
                overflow: hidden;
                background: white !important; /* Economiza tinta */
            }

            /* 2. Mostra APENAS o cart√£o que estamos imprimindo agora */
            .imprimindo-agora, .imprimindo-agora * {
                visibility: visible;
                height: auto;
                overflow: visible;
                color: black !important; /* For√ßa preto puro */
            }

            /* 3. Formata o cart√£o para parecer um cupom */
            .imprimindo-agora {
                position: fixed;
                left: 0;
                top: 0;
                width: 100%; /* Ocupa a largura do papel configurado */
                max-width: 78mm; /* Largura t√≠pica de impressora t√©rmica (80mm) */
                padding: 5px 10px;
                margin: 0;
                border: none !important; /* Tira a borda colorida */
                box-shadow: none !important; /* Tira sombra */
                font-family: 'Courier New', Courier, monospace; /* Fonte estilo m√°quina */
            }

            /* Ajustes finos para o papel */
            .imprimindo-agora .pedido-header { border-bottom: 2px dashed black; }
            .imprimindo-agora .pedido-id { font-size: 24px; }
            .imprimindo-agora .info-cliente strong { font-size: 20px; }
            .imprimindo-agora .lista-itens { background: transparent; padding: 0; }
            .imprimindo-agora .item { border-bottom: 1px dotted black; }
            .imprimindo-agora .total { font-size: 22px; border-top: 2px dashed black; padding-top: 5px; display: block; width: 100%; text-align: right; }

            /* Esconde os bot√µes (n√£o saem no papel) */
            .imprimindo-agora .acoes-btns,
            .imprimindo-agora .btn-print {
                display: none !important;
            }
            
            /* Tira margens do navegador */
            @page { size: auto; margin: 0mm; }
        }
    </style>
</head>
<body>

    <div class="header-pedidos">
        <div>
            <h2>Cozinha / Pedidos üë®‚Äçüç≥</h2>
            <small>Atualiza√ß√£o em tempo real</small>
        </div>
        <a href="admin.html" style="text-decoration:none; color:#333; font-weight:bold;">
            <i class="fa-solid fa-arrow-left"></i> Voltar pro Admin
        </a>
    </div>

    <div id="container-pedidos" class="grid-pedidos">
        <p style="text-align:center; width:100%; color:#999;">
            <i class="fa-solid fa-spinner fa-spin"></i> Carregando pedidos...
        </p>
    </div>

    <audio id="som-notificacao" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AlzaSyBp32ijeLw2LvNwKur5EaUj7B9WZ1G-AW0",
            authDomain: "loucosportapioca-57964.firebaseapp.com",
            projectId: "loucosportapioca-57964",
            storageBucket: "loucosportapioca-57964.firebasestorage.app",
            messagingSenderId: "371332659198",
            appId: "1:371332659198:web:330626357653acc00772af"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Escuta Pedidos em Tempo Real
        db.collection("pedidos").orderBy("data", "desc").onSnapshot((snapshot) => {
            const container = document.getElementById('container-pedidos');
            
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added" && !change.doc.metadata.fromCache) {
                    document.getElementById('som-notificacao').play().catch(e => console.log("Som bloqueado pelo navegador"));
                }
            });

            if(snapshot.empty) {
                container.innerHTML = '<p style="text-align:center; width:100%; color:#999; padding: 50px;">Nenhum pedido por enquanto.</p>';
                return;
            }

            container.innerHTML = ''; // Limpa antes de redesenhar

            snapshot.forEach((doc) => {
                const p = doc.data();
                const id = doc.id;
                const data = p.data.toDate().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                const statusClass = p.status === 'pendente' ? 'status-pendente' : 'status-pronto';
                
                // Monta HTML dos itens
                let itensHtml = '';
                p.itens.forEach(i => {
                    // Verifica se tem observa√ß√£o (futuro) ou descri√ß√£o
                    let desc = i.descricao ? `<br><small style="color:#666; font-style:italic;">(${i.descricao})</small>` : '';
                    itensHtml += `<div class="item"><div><span class="item-qtd">${i.quantidade}x</span> <span>${i.nome}</span> ${desc}</div></div>`;
                });

                // Bot√£o de a√ß√£o muda conforme status
                let btnAcao = '';
                if(p.status === 'pendente') {
                    btnAcao = `<button class="btn-acao btn-pronto" onclick="mudarStatus('${id}', 'pronto')">‚úÖ Pronto</button>`;
                } else {
                    btnAcao = `<button class="btn-acao btn-arquivar" onclick="arquivar('${id}')">üìÅ Arquivar</button>`;
                }

                // ADICIONAMOS UM ID √öNICO AO CARD: id="card-${id}"
                container.innerHTML += `
                    <div id="card-${id}" class="card-pedido ${statusClass}">
                        <div class="pedido-header">
                            <span class="pedido-id">#${id.slice(0,5).toUpperCase()}</span>
                            <span class="pedido-hora">${data}</span>
                        </div>
                        <div class="info-cliente">
                            <strong>${p.cliente.nome}</strong>
                            <span>${p.entrega.tipo === 'entrega' ? 'üõµ Entrega' : 'üëú Retirada'}</span>
                            <div style="font-size:13px; margin-top:5px;">üìç ${p.entrega.endereco}</div>
                             <div style="font-size:13px;">üìû ${p.cliente.telefone}</div>
                        </div>
                        
                        <div class="lista-itens">
                            ${itensHtml}
                        </div>

                         <div style="margin-top:10px; font-size:14px; font-weight:bold; border-top:1px solid #eee; padding-top:5px;">
                            Pagamento: ${p.pagamento.metodo.toUpperCase()} ${p.pagamento.troco ? '(Troco: '+p.pagamento.troco+')' : ''}
                        </div>

                        <div class="pedido-footer">
                            <span class="total">R$ ${p.total.toFixed(2)}</span>
                            
                            <div class="acoes-btns">
                                <button class="btn-print" onclick="imprimirPedido('${id}')" title="Imprimir Cupom">
                                    <i class="fa-solid fa-print"></i>
                                </button>
                                ${btnAcao}
                            </div>
                        </div>
                    </div>
                `;
            });
        });

        // --- FUN√á√ÉO M√ÅGICA DE IMPRESS√ÉO ---
        function imprimirPedido(id) {
            // 1. Acha o cart√£o espec√≠fico na tela
            const card = document.getElementById('card-' + id);
            
            // 2. Adiciona a classe que o CSS de impress√£o est√° esperando
            card.classList.add('imprimindo-agora');
            
            // 3. Abre a caixa de di√°logo do navegador
            window.print();
            
            // 4. Remove a classe para a tela voltar ao normal depois que imprimir/cancelar
            card.classList.remove('imprimindo-agora');
        }

        function mudarStatus(id, status) {
            db.collection("pedidos").doc(id).update({ status: status });
        }

        function arquivar(id) {
            if(confirm("Arquivar este pedido? Ele sumir√° da tela.")) {
                db.collection("pedidos").doc(id).delete();
            }
        }
    </script>
</body>
</html>